# MCP í•œêµ­ ë²•ë ¹ â€” AI Coding Guidelines

> **Purpose**: Complete guide for Cursor AI to work effectively on MCP Korean Legislation
> **Philosophy**: Plan before code, test before complete, ask before breaking
> **Version**: 1.0 (2025-12-31)

---

## Table of Contents

1. [Core Principles](#1-core-principles)
2. [Decision Framework](#2-decision-framework)
3. [Development Environment Management](#3-development-environment-management)
4. [Project Reference](#4-project-reference)
5. [Task Checklists](#5-task-checklists)
6. [Code Patterns](#6-code-patterns)
7. [Prohibited Actions](#7-prohibited-actions)

---

## 1. Core Principles

### 1.0 Sensitive Data Protection (CRITICAL)

**Definition**: API keys, passwords, tokens, OC values

**NEVER**:
- Create `.env` backup files (`.env.bak`, `.env.backup`)
- Add sensitive files to git
- Expose API keys in logs or output
- Hardcode OC values or API keys in code

**Required Confirmation** (in Korean):
```
âš ï¸ "ì´ ì‘ì—…ì€ ë¯¼ê° ì •ë³´(.env, API í‚¤ ë“±)ë¥¼ í¬í•¨í•©ë‹ˆë‹¤. ì§„í–‰í• ê¹Œìš”?"
```

**Safe Alternatives**:
- Use `.env.example` with placeholders
- Reference via `os.environ.get('LEGISLATION_API_KEY')`
- Verify `.gitignore` includes sensitive files

### 1.1 Test Before Complete (CRITICAL)

**Completion Criteria**:
- Code alone is NOT complete
- MUST test before marking TODO as done

**Testing Procedure**:
1. API í˜¸ì¶œ: ì‹¤ì œ ë²•ì œì²˜ API í˜¸ì¶œ í…ŒìŠ¤íŠ¸
2. Tool ë™ì‘: MCP toolì´ ì •ìƒì ìœ¼ë¡œ ë“±ë¡ë˜ê³  ì‹¤í–‰ë˜ëŠ”ì§€ í™•ì¸
3. Integration: ì „ì²´ í”Œë¡œìš° í…ŒìŠ¤íŠ¸

**Correct Flow**:
```
1. Write/modify code
2. Restart service if needed
3. Execute actual test:
   - API: ì‹¤ì œ ë²•ì œì²˜ API í˜¸ì¶œ
   - Tool: MCP tool ì‹¤í–‰ í…ŒìŠ¤íŠ¸
4. Verify result
5. âœ… No errors â†’ Mark TODO complete
6. âŒ Errors found â†’ Fix and retry from step 2
```

### 1.2 Plan Before Code (ALWAYS)

**Before Coding (15-20 min)**:
- Research best practices (web search)
- Review existing patterns in codebase
- Check API documentation in `docs/`
- Compare 2-3 approaches

**After Completion (5-10 min)**:
- Record learnings if significant
- Update documentation if needed

### 1.3 Required Reference Documents

**Priority 1: Project Documents**
- `AGENTS.md` â€” Project structure, workflows, architecture
- `docs/api-master-guide.md` â€” API êµ¬ì¡° ë° íŒ¨í„´
- `docs/api-*.md` â€” ì¹´í…Œê³ ë¦¬ë³„ API ìƒì„¸ ê°€ì´ë“œ

**Priority 2: Skills Documents**
- `skills/tool-development.md` â€” Tool ê°œë°œ ê°€ì´ë“œ
- `skills/api-integration.md` â€” API í†µí•© ê°€ì´ë“œ
- `skills/cache-management.md` â€” ìºì‹œ ê´€ë¦¬
- `skills/graph-search.md` â€” ì§€ì‹ ê·¸ë˜í”„ ê²€ìƒ‰
- `skills/self-improvement.md` â€” ìê°€ ê°œì„  íŒ¨í„´

**Priority 3: Code Reference**
- `src/mcp_kr_legislation/utils/korean_law_api_complete_guide.md` â€” ì „ì²´ API ê°€ì´ë“œ (ì°¸ê³ ìš©)

### 1.4 LLM ì‘ë‹µ ìµœì í™” (IMPORTANT)

**ì›ì¹™**: MCP ë„êµ¬ ì‘ë‹µì€ LLMì— í”¼ë“œë˜ë¯€ë¡œ í† í° íš¨ìœ¨ì„±ì´ ì¤‘ìš”

**MUST**:
- ë¶ˆí•„ìš”í•œ ì´ëª¨ì§€ ì‚¬ìš© ì§€ì–‘ (ì •ë³´ ì „ë‹¬ì— í•„ìˆ˜ì ì¸ ê²½ìš°ë§Œ ì‚¬ìš©)
- í•µì‹¬ ì •ë³´ ìœ„ì£¼ë¡œ í¬ë§·íŒ…
- ì¤‘ë³µ ë°ì´í„° ì œê±°

**MUST NOT**:
- ì‘ë‹µì´ ê¸¸ë‹¤ê³  ì„ì˜ë¡œ ë‚´ìš©ì„ ì¤„ì´ê±°ë‚˜ ìƒëµí•˜ì§€ ë§ ê²ƒ
- ë°ì´í„° í’ˆì§ˆì„ í¬ìƒí•˜ì—¬ ì‘ë‹µ í¬ê¸°ë¥¼ ì¤„ì´ì§€ ë§ ê²ƒ

**ëŒ€ìš©ëŸ‰ ì‘ë‹µ ì²˜ë¦¬ ì „ëµ**:
1. **í•µì‹¬ ì¶”ì¶œ**: ì „ì²´ ë°ì´í„°ì—ì„œ í•µì‹¬ ì •ë³´ë§Œ ì¶”ì¶œí•˜ì—¬ ìš”ì•½ë³¸ ì œê³µ
2. **ìºì‹œí™”**: ëŒ€ìš©ëŸ‰ ë°ì´í„°ëŠ” ìºì‹œì— ì €ì¥í•˜ê³  ìš”ì•½ë³¸ ë°˜í™˜
3. **ë¶„í•  ë„êµ¬**: í•„ìš”ì‹œ ëª©ë¡/ìƒì„¸ ì¡°íšŒë¥¼ ë³„ë„ ë„êµ¬ë¡œ ë¶„ë¦¬
4. **ë‹¨ê³„ì  ì¡°íšŒ**: ìš”ì•½ â†’ ìƒì„¸ ìˆœì„œë¡œ ì¡°íšŒí•  ìˆ˜ ìˆëŠ” ë„êµ¬ êµ¬ì¡°

**Good Example**:
```
**ë²•ë ¹ëª…**: ê°œì¸ì •ë³´ë³´í˜¸ë²•
**MST**: 248613
**ì‹œí–‰ì¼**: 2024-03-15
```

**Bad Example**:
```
ğŸ” **ê²€ìƒ‰ ê²°ê³¼** ğŸ”

ğŸ“œ **ë²•ë ¹ëª…**: ê°œì¸ì •ë³´ë³´í˜¸ë²• âœ¨
ğŸ“‹ **MST**: 248613
ğŸ“… **ì‹œí–‰ì¼**: 2024-03-15 ğŸ‰

ğŸ’¡ ë” ë§ì€ ì •ë³´ê°€ í•„ìš”í•˜ì‹œë©´ ë§ì”€í•´ì£¼ì„¸ìš”! ğŸ˜Š
```

**ì‘ë‹µ í¬ê¸° ê°€ì´ë“œë¼ì¸**:
- ëª©ë¡ ì¡°íšŒ: í•„ìˆ˜ í•„ë“œ í¬í•¨ (ë²•ë ¹ëª…, ID, ì‹œí–‰ì¼ ë“±)
- ìƒì„¸ ì¡°íšŒ: ìš”ì•½ë³¸ ì œê³µ í›„ ì „ì²´ ë°ì´í„°ëŠ” ìºì‹œì—ì„œ ì¡°íšŒ ê°€ëŠ¥í•˜ë„ë¡
- ì—ëŸ¬ ë©”ì‹œì§€: ê°„ê²°í•˜ê²Œ, í•´ê²° ë°©ë²• 1-2ê°œ ì œì‹œ

---

## 2. Decision Framework

### 2.1 When to Ask vs Proceed

**Ask User**:
- Task is ambiguous or has multiple valid interpretations
- Change affects existing working functionality
- Operation involves sensitive data
- Significant architectural decision
- Breaking change to public API

**Proceed Autonomously**:
- Task is clearly defined
- Following established patterns
- Adding new isolated feature
- Fixing obvious bugs
- Routine refactoring within single file

### 2.2 When to Use Existing Code vs Create New

**Pre-Code Checklist (MANDATORY)**:
Before writing ANY new function/component:
```
â–¡ 1. Search codebase for similar functionality
     - grep for keywords related to the task
     - Check tools/, apis/, utils/
     
â–¡ 2. Check if existing code can be:
     - Used directly (import and call)
     - Extended (add parameter, method)
     - Wrapped (thin wrapper for specific use)
     
â–¡ 3. If creating new, ask yourself:
     - Why can't existing code be modified?
     - Will this create duplication?
     - Did I check ALL related files?
```

**Reuse Criteria**:
| Similarity | Action |
|------------|--------|
| 80%+ same | Use existing, modify if needed |
| 50-80% same | Extend existing or extract common |
| <50% same | Create new, document why |

**Anti-Patterns (PROHIBITED)**:
```
âŒ Creating search_law2() when search_law() exists
âŒ New formatting function when law_tools_utils.py exists  
âŒ Duplicate API call logic in multiple files
âŒ Copy-paste with minor modifications
```

**Correct Approach**:
```
âœ… Import and use existing utilities
âœ… Extend existing function with optional parameters
âœ… Create shared component and import everywhere
âœ… Extract common logic to utils layer
```

### 2.3 When to Refactor vs Patch

**Patch** (default for bug fixes):
- Minimal change to fix issue
- No surrounding code cleanup
- Keep PR small and focused

**Refactor** (only when requested):
- User explicitly asks for cleanup
- Bug fix is impossible without refactoring
- Technical debt is blocking feature

---

## 3. Development Environment Management

### 3.1 Environment Setup

**Required**:
- Python 3.10 ì´ìƒ
- uv íŒ¨í‚¤ì§€ ë§¤ë‹ˆì € (ê¶Œì¥) ë˜ëŠ” pip
- ë²•ì œì²˜ API í‚¤ (LEGISLATION_API_KEY)

**Setup**:
```bash
# Python ë²„ì „ í™•ì¸
python3 --version  # 3.10 ì´ìƒì´ì–´ì•¼ í•¨

# ê°€ìƒí™˜ê²½ ìƒì„± (uv ì‚¬ìš©)
uv venv
uv pip install -e .

# ë˜ëŠ” pip ì‚¬ìš©
python3.10 -m venv .venv
source .venv/bin/activate
pip install -e .
```

### 3.2 Environment Variables

`.env` íŒŒì¼ì„ í”„ë¡œì íŠ¸ ë£¨íŠ¸ì— ìƒì„±:

```bash
LEGISLATION_API_KEY=lchangoo  # ë˜ëŠ” ì´ë©”ì¼ ì£¼ì†Œ
LEGISLATION_SEARCH_URL=http://www.law.go.kr/DRF/lawSearch.do
LEGISLATION_SERVICE_URL=http://www.law.go.kr/DRF/lawService.do
HOST=0.0.0.0
PORT=8002
TRANSPORT=stdio
LOG_LEVEL=INFO
MCP_SERVER_NAME=mcp-kr-legislation
```

### 3.3 Service Execution

**Local Development**:
```bash
# stdio transport
python -m mcp_kr_legislation.server

# http transport
TRANSPORT=http python -m mcp_kr_legislation.server
```

**Claude Desktop Integration**:
- ì„¤ì • íŒŒì¼: `~/Library/Application Support/Claude/claude_desktop_config.json`
- ì°¸ê³ : `README.md`ì˜ Claude Desktop ì„¤ì • ì„¹ì…˜

---

## 4. Project Reference

### 4.1 Project Structure

```
src/mcp_kr_legislation/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ server.py                # FastMCP ì„œë²„ ë©”ì¸ ë¡œì§
â”œâ”€â”€ config.py                # ì„¤ì • ê´€ë¦¬ (LegislationConfig, MCPConfig)
â”œâ”€â”€ apis/                    # ë²•ì œì²˜ API í´ë¼ì´ì–¸íŠ¸
â”‚   â”œâ”€â”€ client.py           # LegislationClient (ê¸°ë³¸ í´ë¼ì´ì–¸íŠ¸)
â”‚   â”œâ”€â”€ law_api.py          # ë²•ë ¹ API
â”‚   â””â”€â”€ legislation_api.py  # ìì¹˜ë²•ê·œ API
â”œâ”€â”€ tools/                   # MCP ë„êµ¬ ì •ì˜ (14ê°œ ëª¨ë“ˆ)
â”‚   â”œâ”€â”€ law_tools.py
â”‚   â”œâ”€â”€ precedent_tools.py
â”‚   â”œâ”€â”€ committee_tools.py
â”‚   â””â”€â”€ ...
â”œâ”€â”€ utils/                   # ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
â”‚   â”œâ”€â”€ ctx_helper.py       # ì»¨í…ìŠ¤íŠ¸ ì²˜ë¦¬
â”‚   â”œâ”€â”€ law_tools_utils.py  # ë²•ë ¹ ë„êµ¬ ìœ í‹¸ë¦¬í‹°
â”‚   â””â”€â”€ data_processor.py   # ë°ì´í„° ì²˜ë¦¬
â”œâ”€â”€ registry/               # ë„êµ¬ ë ˆì§€ìŠ¤íŠ¸ë¦¬
â”‚   â”œâ”€â”€ tool_registry.py
â”‚   â””â”€â”€ initialize_registry.py
â””â”€â”€ utils/
    â””â”€â”€ korean_law_api_complete_guide.md  # ì „ì²´ API ê°€ì´ë“œ
```

### 4.2 API Pattern

**ë²•ì œì²˜ API êµ¬ì¡°**:
- **ëª©ë¡ ì¡°íšŒ**: `lawSearch.do?target={value}`
- **ë³¸ë¬¸ ì¡°íšŒ**: `lawService.do?target={value}`
- **target íŒŒë¼ë¯¸í„°**: 50ê°œ ì´ìƒì˜ ê³ ìœ í•œ ê°’ìœ¼ë¡œ ê¸°ëŠ¥ êµ¬ë¶„

**ì˜ˆì‹œ**:
- `target=law`: í˜„í–‰ë²•ë ¹
- `target=prec`: íŒë¡€
- `target=ppc`: ê°œì¸ì •ë³´ë³´í˜¸ìœ„ì›íšŒ ê²°ì •ë¬¸

### 4.3 Tool Pattern

**ê¸°ë³¸ Tool êµ¬ì¡°**:
```python
from typing import Annotated
from mcp_kr_legislation.server import mcp
from mcp.types import TextContent
from mcp_kr_legislation.utils.ctx_helper import with_context

@mcp.tool(
    name="tool_name",
    description="ë„êµ¬ ì„¤ëª… (LLMì´ ì´í•´í•  ìˆ˜ ìˆë„ë¡ ëª…í™•í•˜ê²Œ)",
)
def tool_function(
    param1: Annotated[str, "íŒŒë¼ë¯¸í„° ì„¤ëª…"],
) -> TextContent:
    result = with_context(
        None,  # ctxëŠ” ë‚´ë¶€ì—ì„œ fallback ì²˜ë¦¬
        "tool_name",
        lambda context: context.law_api.search(param1)
    )
    return TextContent(type="text", text=str(result))
```

---

## 5. Task Checklists

### 5.1 Tool Development

**Before Starting**:
- [ ] Check existing tools in `tools/` directory
- [ ] Review API documentation in `docs/`
- [ ] Check similar patterns in codebase

**During Development**:
- [ ] Use `@mcp.tool` decorator
- [ ] Use `with_context()` for API calls
- [ ] Add type hints with `Annotated`
- [ ] Write clear descriptions

**After Completion**:
- [ ] Test tool execution
- [ ] Verify tool appears in MCP server
- [ ] Check error handling

### 5.2 API Integration

**Before Starting**:
- [ ] Check API documentation in `docs/api-*.md`
- [ ] Review existing API patterns in `apis/`
- [ ] Understand target parameter mapping

**During Development**:
- [ ] Use `LegislationClient` for API calls
- [ ] Follow `lawSearch.do` / `lawService.do` pattern
- [ ] Handle OC value correctly (from config)

**After Completion**:
- [ ] Test actual API call
- [ ] Verify response structure
- [ ] Check error cases

### 5.3 Cache Implementation

**Before Starting**:
- [ ] Review `skills/cache-management.md`
- [ ] Check existing cache structure
- [ ] Plan cache key strategy

**During Development**:
- [ ] Use consistent cache directory structure
- [ ] Implement cache save/load functions
- [ ] Handle cache invalidation

**After Completion**:
- [ ] Test cache save/load
- [ ] Verify cache persistence
- [ ] Check cache size management

---

## 6. Code Patterns

### 6.1 Tool Function Pattern

```python
from typing import Annotated
from mcp_kr_legislation.server import mcp
from mcp.types import TextContent
from mcp_kr_legislation.utils.ctx_helper import with_context

@mcp.tool(
    name="search_law",
    description="í˜„í–‰ ë²•ë ¹ ê²€ìƒ‰",
)
def search_law(
    query: Annotated[str, "ê²€ìƒ‰ì–´"],
    display: Annotated[int, "ê²°ê³¼ ê°œìˆ˜ (ê¸°ë³¸ê°’: 20)"] = 20,
) -> TextContent:
    result = with_context(
        None,
        "search_law",
        lambda context: context.law_api.search(
            target="law",
            query=query,
            display=display
        )
    )
    return TextContent(type="text", text=str(result))
```

### 6.2 API Call Pattern

```python
from mcp_kr_legislation.apis.client import LegislationClient
from mcp_kr_legislation.config import legislation_config

client = LegislationClient(config=legislation_config)
result = client.search(
    target="law",
    query="ê°œì¸ì •ë³´ë³´í˜¸ë²•",
    display=20
)
```

### 6.3 Error Handling

```python
try:
    result = with_context(
        None,
        "tool_name",
        lambda context: context.law_api.search(query)
    )
    return TextContent(type="text", text=str(result))
except Exception as e:
    logger.error(f"Tool execution failed: {e}")
    return TextContent(
        type="text",
        text=f"ì˜¤ë¥˜ ë°œìƒ: {str(e)}"
    )
```

---

## 7. Prohibited Actions

### 7.1 Hardcoding (CRITICAL)

```
âŒ Hardcoded OC values (always use config)
âŒ Hardcoded API URLs (use config values)
âŒ Hardcoded field names in responses
âŒ Hardcoded prompts in LLM calls
âœ… Configuration-driven, parameterized approaches
âœ… Helper functions that support multiple formats
```

**Example**:
```python
# âŒ Wrong: Hardcoded OC
oc = "lchangoo"

# âœ… Correct: From config
oc = legislation_config.oc
```

### 7.2 Infinite New Code Creation

```
âŒ Creating new functions when similar exists
âŒ Duplicating existing utility functions
âœ… Maximally reusing existing code
âœ… Extending existing functions
```

### 7.3 Skipping Tests

```
âŒ Marking "complete" without running tests
âŒ Not testing actual API calls
âœ… Actually executing and verifying functionality
âœ… Testing with real API endpoints
```

### 7.4 Missing Error Handling

```
âŒ API calls without try/except
âŒ No timeout handling
âœ… Timeout handling, HTTP error handling, exception wrapping
```

### 7.5 Modifying Working Code Without Asking

```
âŒ Changing existing working tools without user approval
âœ… Ask user before modifying working functionality
âœ… Document why changes are needed
```

### 7.6 Architecture Bypass (CRITICAL)

**NEVER bypass established architecture.**

```
âŒ Direct API calls bypassing client
âŒ Hardcoding values instead of using config
âŒ Creating duplicate cache systems
âœ… Follow established patterns
âœ… Use existing infrastructure
âœ… Report issues instead of workarounds
```

---

## 8. Communication

### 8.1 Language

- **User Interaction**: Korean (í•œêµ­ì–´)
- **Code Comments**: English
- **Documentation**: Korean/English (mixed)
- **Commit Messages**: English

### 8.2 Response Style

**DO**:
- Be concise, no unnecessary explanation
- State what was changed, not how it works
- Report test results critically (not optimistically)
- Admit uncertainty when present

**DON'T**:
- Add explanatory padding
- Repeat what user already knows
- Over-explain code changes
- Use emojis unless user does

### 8.3 Critical Analysis Mindset

**ALWAYS**:
- Analyze results critically, not positively
- Question if test truly passed
- Look for edge cases
- Report what's NOT working, not just what IS

**Example**:
```
âŒ "Implementation complete. Everything works."
âœ… "ê¸°ëŠ¥ êµ¬í˜„ ì™„ë£Œ. ë‹¨, ì—ëŸ¬ ì¼€ì´ìŠ¤ í…ŒìŠ¤íŠ¸ í•„ìš”: ë¹ˆ ì…ë ¥, íƒ€ì„ì•„ì›ƒ."
```

---

## 9. User Preferences (Learned)

### 9.1 Communication
- Communicate in Korean
- Be concise, no unnecessary explanation
- Report only what changed

### 9.2 Development
- Critical analysis over positive interpretation
- Test before marking complete
- Ask before modifying working code
- Think deeply before suggesting changes

### 9.3 Prohibited
- Hardcoding values (especially OC, API URLs)
- Creating infinite new functions
- Skipping tests
- Over-engineering simple tasks
- Modifying working code without approval

---

**Last Updated**: 2025-12-31  
**Version**: 1.0
